#======================================================================
#clean workspace
rm(list = ls())
graphics.off()
gc()
#======================================================================
#load directory
dir_root <- "C:/Users/rhd630/Desktop/PhD/damocles_summer_school"
dir_data <- file.path(dir_root, "data")
dir_climate <-file.path(dir_data, "climate")
#======================================================================
#load libraries
library(tidyverse)
library(raster)
library(sf)
library(lubridate)
library(colorspace)
#======================================================================
#setup the loop
#======================================================================
#vector of variable names
var_names <- c("t2m")
#----------------------------------------------------------------------
#list to store variables
var_list <- vector('list', length(var_names))
#add names for each variable
names(var_list) <- var_names
#list to store all detrended climate variables
climate_list_dtr<- var_list
#======================================================================
#loop over various climate variables
#======================================================================
#loop over various variables
for (var_name in var_names) {
climate_list_dtr[[match(var_name, var_names)]] <-
list.files(dir_climate, var_name, full.names = TRUE) %>%
brick() %>%
rasterToPoints() %>%
as_tibble() %>%
rename_all( ~ (str_replace(., "X", ""))) %>%
pivot_longer(cols = -c(x, y)) %>%
mutate(
date = lubridate::ymd(as.character(name)),
year = lubridate::year(date),
month = lubridate::month(date)
) %>%
group_by(x, y, month) %>%
nest() %>%
mutate(model_trend = map(data,  ~ lm(value ~ year, data = .))) %>%
mutate(augment_trend  = map(model_trend,  ~ broom::augment(.))) %>%
mutate(date  = map(data,  ~ .$date)) %>%
unnest(cols = c(augment_trend, date)) %>%
ungroup() %>%
dplyr::select(x, y,.resid,data) %>%
unnest(cols = c(data)) %>%
group_by(x, y, month) %>%
mutate_at(vars(-year, -x, -y, -month, -date),
~ scale(., center = TRUE, scale = TRUE)) %>%
ungroup()
}
#==============================
#==============================
#==============================
#==============================
#FOR EXPLAINING
#vector of variable names
var_name <- c("t2m")
#example list
example_test <- var_list
#give subsample coordinates
x_min <-25
x_max <-30
y_min <-35
y_max <-40
#create example test
example_test[[match(var_name,var_names)]] <-
list.files(dir_climate, var_name, full.names = TRUE) %>%
brick() %>%
rasterToPoints() %>%
as_tibble() %>%
rename_all(~ (str_replace(., "X", ""))) %>%
pivot_longer(cols = -c(x, y)) %>%
filter(x > x_min & x < x_max & y > y_min & y < y_max)
#example list
example_test <- var_list
#give subsample coordinates
x_min <-25
x_max <-30
y_min <-35
y_max <-40
#create example test
example_test[[match(var_name,var_names)]] <-
list.files(dir_climate, var_name, full.names = TRUE) %>%
brick() %>%
rasterToPoints() %>%
as_tibble() %>%
rename_all(~ (str_replace(., "X", ""))) %>%
pivot_longer(cols = -c(x, y)) %>%
filter(x > x_min & x < x_max & y > y_min & y < y_max)
example_test
#give subsample coordinates
x_min <-28
x_max <-30
y_min <-38
y_max <-40
#create example test
example_test[[match(var_name,var_names)]] <-
list.files(dir_climate, var_name, full.names = TRUE) %>%
brick() %>%
rasterToPoints() %>%
as_tibble() %>%
rename_all(~ (str_replace(., "X", ""))) %>%
pivot_longer(cols = -c(x, y)) %>%
filter(x > x_min & x < x_max & y > y_min & y < y_max)
#run code over subsample
example_subset <-example_test$t2m %>%
mutate(
date = lubridate::ymd(as.character(name)),
year = lubridate::year(date),
month = lubridate::month(date)
) %>%
group_by(x, y) %>%
nest() %>%
mutate(model_trend = map(data,  ~ lm(value ~ year, data = .))) %>%
mutate(augment_trend  = map(model_trend,  ~ broom::augment(.))) %>%
mutate(date  = map(data,  ~ .$date)) %>%
unnest(cols = c(augment_trend, date)) %>%
ungroup() %>%
dplyr::select(x, y,.resid,data) %>%
unnest(cols = c(data)) %>%
group_by(x, y, month) %>%
mutate_at(vars(.resid),
~ scale(., center = TRUE, scale = TRUE)) %>%
ungroup()
#quick plot
example_subset %>%
ggplot(aes(x=x,y=y,fill =.resid))+
geom_raster()+
facet_grid(~month)+
scale_fill_continuous_diverging("Blue-Red 2")
example_subset
#quick plot
example_subset %>%
ggplot(aes(x=x,y=y,fill =.resid))+
geom_raster()+
facet_grid(year~month)+
scale_fill_continuous_diverging("Blue-Red 2")
#give subsample coordinates
x_min <-29
x_max <-30
y_min <-39
y_max <-40
#create example test
example_test[[match(var_name,var_names)]] <-
list.files(dir_climate, var_name, full.names = TRUE) %>%
brick() %>%
rasterToPoints() %>%
as_tibble() %>%
rename_all(~ (str_replace(., "X", ""))) %>%
pivot_longer(cols = -c(x, y)) %>%
filter(x > x_min & x < x_max & y > y_min & y < y_max)
#run code over subsample
example_subset <-example_test$t2m %>%
mutate(
date = lubridate::ymd(as.character(name)),
year = lubridate::year(date),
month = lubridate::month(date)
) %>%
group_by(x, y) %>%
nest() %>%
mutate(model_trend = map(data,  ~ lm(value ~ year, data = .))) %>%
mutate(augment_trend  = map(model_trend,  ~ broom::augment(.))) %>%
mutate(date  = map(data,  ~ .$date)) %>%
unnest(cols = c(augment_trend, date)) %>%
ungroup() %>%
dplyr::select(x, y,.resid,data) %>%
unnest(cols = c(data)) %>%
group_by(x, y, month) %>%
mutate_at(vars(.resid),
~ scale(., center = TRUE, scale = TRUE)) %>%
ungroup()
#quick plot
example_subset %>%
ggplot(aes(x=x,y=y,fill =.resid))+
geom_raster()+
facet_grid(year~month)+
scale_fill_continuous_diverging("Blue-Red 2")
#======================================================================
#clean workspace
rm(list = ls())
graphics.off()
gc()
#======================================================================
#load directory
dir_root <- "C:/Users/rhd630/Desktop/PhD/damocles_summer_school"
dir_data <- file.path(dir_root, "data")
dir_climate <-file.path(dir_data, "climate")
#======================================================================
#load libraries
library(tidyverse)
library(raster)
library(sf)
library(lubridate)
library(colorspace)
library(stars)
#==============================
#==============================
#==============================
#==============================
#FOR EXPLAINING
#vector of variable names
var_name <- c("t2m")
#example list
example_test <- var_list
#give subsample coordinates
x_min <-25
#----------------------------------------------------------------------
#list to store variables
var_list <- vector('list', length(var_names))
#add names for each variable
names(var_list) <- var_names
#======================================================================
#setup the loop
#======================================================================
#vector of variable names
var_names <- c("t2m")
#----------------------------------------------------------------------
#list to store variables
var_list <- vector('list', length(var_names))
#add names for each variable
names(var_list) <- var_names
#list to store all detrended climate variables
climate_list_dtr<- var_list
#======================================================================
#loop over various climate variables
#======================================================================
#loop over various variables
for (var_name in var_names) {
climate_list_dtr[[match(var_name, var_names)]] <-
list.files(dir_climate, var_name, full.names = TRUE) %>%
brick() %>%
rasterToPoints() %>%
as_tibble() %>%
rename_all( ~ (str_replace(., "X", ""))) %>%
pivot_longer(cols = -c(x, y)) %>%
mutate(
date = lubridate::ymd(as.character(name)),
year = lubridate::year(date),
month = lubridate::month(date)
) %>%
#main processing steps
group_by(x, y) %>%
nest() %>%
mutate(model_trend = map(data,  ~ lm(value ~ year, data = .))) %>%
mutate(augment_trend  = map(model_trend,  ~ broom::augment(.))) %>%
mutate(date  = map(data,  ~ .$date)) %>%
unnest(cols = c(augment_trend, date)) %>%
ungroup() %>%
dplyr::select(x, y,.resid,data) %>%
unnest(cols = c(data)) %>%
group_by(x, y, month) %>%
mutate_at(vars(.resid),
~ scale(., center = TRUE, scale = TRUE)) %>%
ungroup()
}
example_test[[match(var_name,var_names)]] <-
list.files(dir_climate, var_name, full.names = TRUE)
#example list
example_test <- var_list
example_test[[match(var_name,var_names)]] <-
list.files(dir_climate, var_name, full.names = TRUE)
example_test
#create example test
example_test[[match(var_name,var_names)]] <-
list.files(dir_climate, var_name, full.names = TRUE) %>%
read_stars()
list.files(dir_climate, var_name, full.names = TRUE) %>%
read_stars -> test
test
test[,,,1]
st_apply(test,"time",mean)
st_apply(test,c("x","y"),mean)
test_mean <- st_apply(test,c("x","y"),mean)
plot(test_mean)
test
st_get_dimension_values(test,"time")
test_pixel <- test[,23,55,]
test_pixel
test_pixel$t2m.monthly.era5.europe.1981.2020.nc
test_pixel <- test[,23,55,,drop=TRUE]
test_pixel
test_pixel$t2m.monthly.era5.europe.1981.2020.nc
test_pixel_values <- test_pixel$t2m.monthly.era5.europe.1981.2020.nc
for (i in 1:12:480) {
print(i)
}
seq(1,480,12)
for (i in seq(1,480,12)) {
print(i)
}
for (i in seq(1,480,12)) {
test_pixel_values[i]
}
for (i in seq(1,480,12)) {
print(test_pixel_values[i])
}
seq(1,480,12)test
list.files(dir_climate, var_name, full.names = TRUE) %>%
read_stars -> test
test
#create example test
example_test<-
list.files(dir_climate, var_name, full.names = TRUE) %>%
read_stars  %>%
split("band")
example_test
#create example test
example_test<-
list.files(dir_climate, var_name, full.names = TRUE) %>%
read_stars  %>%
split("time")
example_test
slope = function(x) {
if (anyNA(x))
NA_real_
else
lm.fit(cbind(1, t), x)$coefficients[2]
}
#create example test
example_test<-
list.files(dir_climate, var_name, full.names = TRUE) %>%
read_stars  %>%
st_apply(c("x","y"),slope)
example_test<-
list.files(dir_climate, var_name, full.names = TRUE) %>%
read_stars  %>%
st_apply(adrop(y), c("x","y"),slope)
example_test
test
(t = st_get_dimension_values(y, 4))
(t = st_get_dimension_values(test, 4))
example_test<-
list.files(dir_climate, var_name, full.names = TRUE) %>%
read_stars
(t = st_get_dimension_values(example_test, 4))
t
(tt = st_get_dimension_values(example_test, 4))
(t = st_get_dimension_values(example_test))
example_test
library(stars)
x = c("avhrr-only-v2.19810901.nc",
"avhrr-only-v2.19810902.nc",
"avhrr-only-v2.19810903.nc",
"avhrr-only-v2.19810904.nc",
"avhrr-only-v2.19810905.nc",
"avhrr-only-v2.19810906.nc",
"avhrr-only-v2.19810907.nc",
"avhrr-only-v2.19810908.nc",
"avhrr-only-v2.19810909.nc")
file_list = system.file(paste0("netcdf/", x), package = "starsdata")
y = read_stars(file_list, sub = "sst", quiet = TRUE, proxy = TRUE)
(t = st_get_dimension_values(y, 4))
library(stars)
x = c("avhrr-only-v2.19810901.nc",
"avhrr-only-v2.19810902.nc",
"avhrr-only-v2.19810903.nc",
"avhrr-only-v2.19810904.nc",
"avhrr-only-v2.19810905.nc",
"avhrr-only-v2.19810906.nc",
"avhrr-only-v2.19810907.nc",
"avhrr-only-v2.19810908.nc",
"avhrr-only-v2.19810909.nc")
file_list = system.file(paste0("netcdf/", x), package = "starsdata")
y = read_stars(file_list, sub = "sst", quiet = TRUE, proxy = TRUE)
(t = st_get_dimension_values(y, 4))
x = c("avhrr-only-v2.19810901.nc",
"avhrr-only-v2.19810902.nc",
"avhrr-only-v2.19810903.nc",
"avhrr-only-v2.19810904.nc",
"avhrr-only-v2.19810905.nc",
"avhrr-only-v2.19810906.nc",
"avhrr-only-v2.19810907.nc",
"avhrr-only-v2.19810908.nc",
"avhrr-only-v2.19810909.nc")
x
file_list = system.file(paste0("netcdf/", x), package = "starsdata")
file_list
y = read_stars(file_list, sub = "sst", quiet = TRUE, proxy = TRUE)
example_test<-
list.files(dir_climate, var_name, full.names = TRUE) %>%
read_stars
example_test
(t = st_get_dimension_values(example_test, 4))
(t = st_get_dimension_values(example_test, 3))
example_test<-
list.files(dir_climate, var_name, full.names = TRUE) %>%
read_stars
example_test
data <-c(x = 1:40,y= 1:40)
data
data <-tibble(x = 1:40, y = 1:40)
data
lm(x~y)
lm(x~y,data = data)
lm(x~y,data = data) %>%  broom::augment()
lm(x~y,data = data) %>%  broom::augment() %>%  .resid
lm(x~y,data = data) %>%  broom::augment() %>%  dplyr::select(.resid)
lm_detrend = function(x) {
if (anyNA(x))
NA_real_
else
lm(x~t) %>%  broom::augment() %>%
dplyr::select(.resid)
}
lm_detrend = function(x) {
if (anyNA(x))
NA_real_
else
lm(x~t) %>%  broom::augment() %>%
dplyr::select(.resid)
}
(t = st_get_dimension_values(y, 4))
(t = st_get_dimension_values(y, 3))
example_test<-
list.files(dir_climate, var_name, full.names = TRUE) %>%
read_stars
lm_detrend = function(x) {
if (anyNA(x))
NA_real_
else
lm(x~t) %>%  broom::augment() %>%
dplyr::select(.resid)
}
#======================================================================
#clean workspace
rm(list = ls())
graphics.off()
gc()
#======================================================================
#load directory
dir_root <- "C:/Users/rhd630/Desktop/PhD/damocles_summer_school"
dir_data <- file.path(dir_root, "data")
dir_climate <-file.path(dir_data, "climate")
#======================================================================
#load libraries
library(tidyverse)
library(raster)
library(sf)
library(stars)
library(lubridate)
library(colorspace)
#======================================================================
#setup the loop
#======================================================================
#vector of variable names
var_names <- c("t2m")
#----------------------------------------------------------------------
#list to store variables
var_list <- vector('list', length(var_names))
#add names for each variable
names(var_list) <- var_names
#list to store all detrended climate variables
climate_list_dtr<- var_list
var_name <- c("t2m")
#example list
example_test <- var_list
lm_detrend = function(x) {
if (anyNA(x))
NA_real_
else
lm(x~t) %>%  broom::augment() %>%
dplyr::select(.resid)
}
#create example test
example_test<-
list.files(dir_climate, var_name, full.names = TRUE) %>%
read_stars
(t = st_get_dimension_values(y, 3))
(t = st_get_dimension_values(example_test, 3))
test_mean <- st_apply(example_test,c("x","y"),lm_detrend)
test_mean
tibble(a = 1:40,
b = 1:40)
df <-tibble(a = 1:40,
b = 1:40)
lm_detrend(df)
lm_detrend
df
